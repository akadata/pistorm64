<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<!-- AG2HTML: CONVERTER=AG2HTML/1.1 FORMAT=AMIGAGUIDE/34.11 FILE="Devices/Dev_2" NODE="2-6-4" TITLE="2 / Allocation and Arbitration Commands / ADCMD_LOCK" INDEX="Devices/Dev_Index/MAIN" -->
<head>
<title>2 / Allocation and Arbitration Commands / ADCMD_LOCK</title>
</head>
<body>
<img src="../images/toc_d.gif" alt="[Contents]">
<a href="../Devices_Manual_guide/node012A.html"><img src="../images/index.gif" alt="[Index]" border=0></a>
<img src="../images/help_d.gif" alt="[Help]">
<img src="../images/retrace_d.gif" alt="[Retrace]">
<a href="../Devices_Manual_guide/node0030.html"><img src="../images/prev.gif" alt="[Browse &#060;]" border=0></a>
<a href="../Devices_Manual_guide/node0032.html"><img src="../images/next.gif" alt="[Browse &#062;]" border=0></a>
<hr>
<pre>
<!-- AG2HTML: BODY=START -->
The <a href="../Includes_and_Autodocs_2._guide/node04A9.html">ADCMD_LOCK</a> command performs the &#034;steal verify&#034; function. When
another application is attempting to steal a channel or channels,
ADCMD_LOCK gives you a chance to clean up before the channel is stolen.
You perform a ADCMD_LOCK command right after the <a href="../Devices_Manual_guide/node002A.html">ADCMD_ALLOCATE</a> command.
ADCMD_LOCK does not return until a higher-priority user attempts to steal
the channel(s) or you perform an <a href="../Devices_Manual_guide/node002F.html">ADCMD_FREE</a> command. If someone is
attempting to steal, you must finish up and ADCMD_FREE the channel as
quickly as possible.

You must use <a href="../Includes_and_Autodocs_2._guide/node04A9.html">ADCMD_LOCK</a> if you want to write directly to the hardware
registers instead of using the device commands. If your channel is stolen,
you are not notified unless the ADCMD_LOCK command is present. This could
cause problems for the task that has stolen the channel and is now using
it at the same time as your task. ADCMD_LOCK sets a switch that is not
cleared until you perform an ADCMD_FREE command on the channel. Canceling
an ADCMD_LOCK request with <a href="../Includes_and_Autodocs_2._guide/node04A5.html">AbortIO()</a> will not free the channel.

The following outline describes how <a href="../Includes_and_Autodocs_2._guide/node04A9.html">ADCMD_LOCK</a> works when a channel is
stolen and when it is not stolen.

   1. User A allocates a channel.
   2. User A locks the channel.

If User B allocates the channel with a higher precedence:

   3. User B's <a href="../Devices_Manual_guide/node002A.html">ADCMD_ALLOCATE</a> command is suspended (regardless of the
      setting of the ADIOF_NOWAIT flag).
   4. User A's lock command is replied to with an error
      (ADIOERR_CHANNELSTOLEN).
   5. User A does whatever is needed to finish up when a channel is stolen.
   6. User A frees the channel with <a href="../Devices_Manual_guide/node002F.html">ADCMD_FREE</a>.
   7. User B's <a href="../Devices_Manual_guide/node002A.html">ADCMD_ALLOCATE</a> command is replied to. Now user B has the
      channel.

Otherwise, if the channel is not allocated by another user:

   3. User A finishes the sound.
   4. User A performs the <a href="../Devices_Manual_guide/node002F.html">ADCMD_FREE</a> command.
   5. User A's <a href="../Includes_and_Autodocs_2._guide/node04A9.html">ADCMD_LOCK</a> command is replied to.

Never make the freeing of a channel (if the channel is stolen) dependent
on allocating another channel. This may cause a deadlock. If you want
channels back after they have been stolen, you must reallocate them with
the same allocation key. To keep a channel and never let it be stolen, set
precedence to maximum (127). Do not use a lock for this purpose.
<!-- AG2HTML: BODY=END -->
</pre>

<!-- [amigadev.elowar.com] Automatically generated content... -->
<hr />
<pre>[Back to <a href="http://amigadev.elowar.com/">Amiga Developer Docs</a>]</pre>
<!-- [amigadev.elowar.com] End of automatically generated content. -->

</body>
</html>
