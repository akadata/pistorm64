<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<!-- AG2HTML: CONVERTER=AG2HTML/1.1 FORMAT=AMIGAGUIDE/34.11 FILE="Devices/apps/ScreenSave/ScreenSave.c" NODE="MAIN" TITLE="Devices/apps/ScreenSave/ScreenSave.c" -->
<head>
<title>Devices/apps/ScreenSave/ScreenSave.c</title>
</head>
<body>
<img src="../images/toc_d.gif" alt="[Contents]">
<img src="../images/index_d.gif" alt="[Index]">
<img src="../images/help_d.gif" alt="[Help]">
<img src="../images/retrace_d.gif" alt="[Retrace]">
<a href="../Devices_Manual_guide/node02FC.html"><img src="../images/prev.gif" alt="[Browse &#060;]" border=0></a>
<a href="../Devices_Manual_guide/node02FE.html"><img src="../images/next.gif" alt="[Browse &#062;]" border=0></a>
<hr>
<pre>
<!-- AG2HTML: BODY=START -->
/* ScreenSave
 * Saves front screen as an ILBM
 * Requires linkage with several iffparse modiules - See Makefile
 */

#include &#034;iffp/ilbmapp.h&#034;

#include &#060;intuition/intuitionbase.h&#062;
#include &#060;workbench/workbench.h&#062;

#include &#060;clib/icon_protos.h&#062;

#ifdef LATTICE
int CXBRK(void) { return(0); }  /* Disable Lattice CTRL/C handling */
int chkabort(void) { return(0); }  /* really */
#endif

char *vers = &#034;\0$VER: screensave 37.5&#034;;
char *Copyright =
  &#034;screensave v37.5 - supports new modes - Freely Redistributable&#034;;
char *usage =
 &#034;Usage: screensave filename (filename -c[unit] for clipboard)\n&#034;
 &#034;Options: QUIET, NODELAY, NOICON, SEQUENCE (sequence adds a number to name)\n&#034;
 &#034;Saves front screen after 10-sec delay (unless NODELAY).\n&#034;;

int mygets(char *s);
void bye(UBYTE *s,int e);
void cleanup(void);

struct Library	*IntuitionBase = NULL;
struct Library	*GfxBase = NULL;
struct Library	*IconBase = NULL;
struct Library	*IFFParseBase = NULL;

struct ILBMInfo ilbm = {0};

BOOL fromWB, Quiet, NoDelay, NoIcon, Sequence;



#define INBUFSZ 128
char nbuf[INBUFSZ];

/* Data for project icon for saved ILBM
 *
 */
UWORD ILBMI1Data[] =
{
/* Plane 0 */
    0x0000,0x0000,0x0000,0x0001,0x0000,0x0000,0x0000,0x0003,
    0x0FFF,0xFFFF,0xFFFF,0xFFF3,0x0FFF,0x0000,0x0000,0xFFF3,
    0x0FFC,0x0000,0x0000,0x3FF3,0x0FE0,0x0E80,0xF800,0x07F3,
    0x0F80,0x1C01,0x8C00,0x01F3,0x0F00,0x0001,0x8C00,0x00F3,
    0x0600,0x0000,0x0600,0x0063,0x0600,0x0003,0xBC00,0x0063,
    0x0600,0x0001,0xFC00,0x0063,0x0600,0x0000,0xFC00,0x0063,
    0x0600,0x1FC1,0xFE40,0x0063,0x0600,0x1DC1,0xFE20,0x0063,
    0x0600,0x1CE3,0xFF12,0x0063,0x0F00,0x1CE0,0x004F,0xC0F3,
    0x0F80,0x1CE0,0x002F,0x01F3,0x0FE0,0x0E78,0x423D,0x07F3,
    0x0FFC,0x0000,0x0000,0x3FF3,0x0FFF,0x0000,0x0000,0xFFF3,
    0x0FFF,0xFFFF,0xFFFF,0xFFF3,0x0000,0x0000,0x0000,0x0003,
    0x7FFF,0xFFFF,0xFFFF,0xFFFF,
/* Plane 1 */
    0xFFFF,0xFFFF,0xFFFF,0xFFFE,0xD555,0x5555,0x5555,0x5554,
    0xD000,0x0000,0x0000,0x0004,0xD3FC,0xFFFF,0xFFFF,0x3FC4,
    0xD3C0,0x0000,0x0000,0x03C4,0xD300,0x0100,0xF800,0x00C4,
    0xD300,0x0381,0xFC00,0x00C4,0xD080,0x0701,0xFC00,0x0104,
    0xD180,0xF883,0xFE00,0x0194,0xD181,0xDF80,0x4700,0x0194,
    0xD181,0xDF82,0x0180,0x0194,0xD180,0x6F82,0x00C0,0x0194,
    0xD180,0x0002,0x0020,0x0194,0xD180,0x0000,0x0000,0x0194,
    0xD180,0x0000,0x0002,0x0194,0xD080,0x0000,0xCC46,0xC104,
    0xD300,0x0000,0xCC2F,0x00C4,0xD300,0x0E78,0x883D,0x00C4,
    0xD3C0,0x0000,0x0000,0x03C4,0xD3FC,0xFFFF,0xFFFF,0x3FC4,
    0xD000,0x0000,0x0000,0x0004,0xD555,0x5555,0x5555,0x5554,
    0x8000,0x0000,0x0000,0x0000,
};

struct Image ILBMI1 =
{
    0, 0,			/* Upper left corner */
    64, 23, 2,			/* Width, Height, Depth */
    ILBMI1Data,			/* Image data */
    0x0003, 0x0000,		/* PlanePick, PlaneOnOff */
    NULL			/* Next image */
};

UBYTE *ILBMTools[] =
{
    &#034;FILETYPE=ILBM&#034;,
    NULL
};

struct DiskObject ILBMobject =
{
    WB_DISKMAGIC,		/* Magic Number */
    WB_DISKVERSION,		/* Version */
    {				/* Embedded Gadget Structure */
	NULL,			/* Next Gadget Pointer */
	0, 0, 64, 24,		/* Left,Top,Width,Height */
	GADGIMAGE | GADGBACKFILL,	/* Flags */
	RELVERIFY | GADGIMMEDIATE,		/* Activation Flags */
	BOOLGADGET,		/* Gadget Type */
	(APTR)&#038;ILBMI1,	/* Render Image */
	NULL,			/* Select Image */
	NULL,			/* Gadget Text */
	NULL,			/* Mutual Exclude */
	NULL,			/* Special Info */
	0,			/* Gadget ID */
	NULL,			/* User Data */
    },
    WBPROJECT,			/* Icon Type */
    &#034;Display&#034;,			/* Default Tool */
    ILBMTools,			/* Tool Type Array */
    NO_ICON_POSITION,		/* Current X */
    NO_ICON_POSITION,		/* Current Y */
    NULL,			/* Drawer Structure */
    NULL,			/* Tool Window */
    0				/* Stack Size */
};



void main(int argc, char **argv)
   {
   struct Screen   *frontScreen;
   LONG		error = 0L, seqlock;
   char         *filename;
   int l, k;

   fromWB = (argc==0) ? TRUE : FALSE;


   if(!(IntuitionBase = OpenLibrary(&#034;intuition.library&#034;, 0)))
      bye(&#034;Can't open intuition library.\n&#034;,RETURN_WARN);

   if(!(GfxBase = OpenLibrary(&#034;graphics.library&#034;,0)))
      bye(&#034;Can't open graphics library.\n&#034;,RETURN_WARN);

   if(!(IFFParseBase = OpenLibrary(&#034;iffparse.library&#034;,0)))
      bye(&#034;Can't open iffparse library.\n&#034;,RETURN_WARN);

   if(!(IconBase = OpenLibrary(&#034;icon.library&#034;,0)))
      bye(&#034;Can't open icon library.\n&#034;,RETURN_WARN);

   if(!(ilbm.ParseInfo.iff = AllocIFF()))
      bye(IFFerr(IFFERR_NOMEM),RETURN_WARN);

   if(argc&#062;1)                 /* Passed filename via command line  */
      {
      if(argv[1][0]=='?')
	    {
	    printf(&#034;%s\n%s\n&#034;,Copyright,usage);
	    bye(&#034;\n&#034;,RETURN_OK);
	    }
      else filename = argv[1];

      NoDelay = NoIcon = Quiet = Sequence = FALSE;
      for(k=2; k &#060; (argc); k++)
	{
	if(!(stricmp(argv[k],&#034;NODELAY&#034;)))	NoDelay  = TRUE;
	else if(!(stricmp(argv[k],&#034;NOICON&#034;)))	NoIcon   = TRUE;
	else if(!(stricmp(argv[k],&#034;QUIET&#034;)))	Quiet    = TRUE;
	else if(!(stricmp(argv[k],&#034;SEQUENCE&#034;)))	Sequence = TRUE;
	}
      if(Sequence)
	{
	for(k=1; k&#060;9999; k++)
	    {
	    sprintf(nbuf,&#034;%s%04ld&#034;,filename,k);
	    if(seqlock = Lock(nbuf,ACCESS_READ))	UnLock(seqlock);
	    else break;
	    }
	filename = nbuf;
	}
      }
   else
      {
      printf(&#034;%s\n%s\n&#034;,Copyright,usage);
      printf(&#034;Enter filename for save: &#034;);
      l = mygets(&#038;nbuf[0]);

      if(l==0)                /* No filename - Exit */
         {
         bye(&#034;\nScreen not saved, filename required\n&#034;,RETURN_FAIL);
         }
      else
         {
         filename = &#038;nbuf[0];
         }
      }

   if(!NoDelay)	Delay(500);

   Forbid();
   frontScreen  = ((struct IntuitionBase *)IntuitionBase)-&#062;FirstScreen;
   Permit();

   if(error = screensave(&#038;ilbm, frontScreen,
				NULL, NULL,
				filename))
	{
	printf(&#034;%s\n&#034;,IFFerr(error));
	}
   else
	{
      	if(!Quiet) printf(&#034;Screen saved as %s... &#034;,filename);
	if((!NoIcon)&#038;&#038;(filename[0]!='-')&#038;&#038;(filename[1]!='c')) /* not clipboard */
	    {
      	    if(!(PutDiskObject(filename,&#038;ILBMobject)))
            	{
            	bye(&#034;Error saving icon\n&#034;,RETURN_WARN);
            	}
   	    if(!Quiet) printf(&#034;Icon saved\n&#034;);
	    }
	else if(!Quiet) printf(&#034;\n&#034;);
      	bye(&#034;&#034;,RETURN_OK);
      	}
    }


void bye(UBYTE *s,int e)
   {
   if(s&#038;&#038;(*s)) printf(&#034;%s\n&#034;,s);
   if ((fromWB)&#038;&#038;(*s))    /* Wait so user can read messages */
      {
      printf(&#034;\nPRESS RETURN TO EXIT\n&#034;);
      mygets(&#038;nbuf[0]);
      }
   cleanup();
   exit(e);
   }

void cleanup()
   {
   if(ilbm.ParseInfo.iff)	FreeIFF(ilbm.ParseInfo.iff);

   if(GfxBase)		CloseLibrary(GfxBase);
   if(IntuitionBase)	CloseLibrary(IntuitionBase);
   if(IconBase)		CloseLibrary(IconBase);
   if(IFFParseBase)	CloseLibrary(IFFParseBase);
   }


int mygets(char *s)
   {
   int l = 0, max = INBUFSZ - 1;

   while (((*s = getchar()) !='\n' )&#038;&#038;(l &#060; max)) s++, l++;
   *s = NULL;
   return(l);
   }
<!-- AG2HTML: BODY=END -->
</pre>

<!-- [amigadev.elowar.com] Automatically generated content... -->
<hr />
<pre>[Back to <a href="http://amigadev.elowar.com/">Amiga Developer Docs</a>]</pre>
<!-- [amigadev.elowar.com] End of automatically generated content. -->

</body>
</html>
