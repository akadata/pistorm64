<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<!-- AG2HTML: CONVERTER=AG2HTML/1.1 FORMAT=AMIGAGUIDE/34.11 FILE="Devices/Dev_A_FS_SMUS" NODE="16-5-2-3" TITLE=" Background / Instrument Registers " INDEX="Devices/Dev_Index/MAIN" -->
<head>
<title> Background / Instrument Registers </title>
</head>
<body>
<img src="../images/toc_d.gif" alt="[Contents]">
<a href="../Devices_Manual_guide/node012A.html"><img src="../images/index.gif" alt="[Index]" border=0></a>
<img src="../images/help_d.gif" alt="[Help]">
<img src="../images/retrace_d.gif" alt="[Retrace]">
<a href="../Devices_Manual_guide/node02AF.html"><img src="../images/prev.gif" alt="[Browse &#060;]" border=0></a>
<a href="../Devices_Manual_guide/node02B1.html"><img src="../images/next.gif" alt="[Browse &#062;]" border=0></a>
<hr>
<pre>
<!-- AG2HTML: BODY=START -->
Instrument reference.  In <a href="../Devices_Manual_guide/node02AC.html#line8">SSSP</a>, each note event points to a &#034;timbre
object&#034; which supplies the &#034;instrument&#034; (the sound driver data) for that
note.  FORM <a href="../Devices_Manual_guide/node02AB.html">SMUS</a> stores these pointers as a &#034;current instrument setting&#034;
for each track. It's just a run encoded version of the same information.
<a href="../Devices_Manual_guide/node02AC.html#line8">SSSP reference</a> uses a symbol table to hold all the pointers to &#034;timbre
object&#034;. <a href="../Devices_Manual_guide/node02AB.html">SMUS</a> uses INS1 chunks for the same purpose.  They name the
score's instruments.

The actual instrument data to use depends on the playback environment, but
we want the score to be independent of environment.  Different playback
environments have different audio output hardware and different sound
driver software.  And there are channel allocation issues like how many
output channels there are, which ones are polyphonic, and which I/O ports
they're connected to.  If you use MIDI to control the instruments, you get
into issues of what kind of device is listening to each MIDI channel and
what each of its presets sounds like.  If you use computer-based
instruments, you need driver- specific data like waveform tables and
oscillator parameters.

We just want some orchestration.  If the score wants a &#034;piano&#034;, we let the
playback program find a &#034;piano&#034;.

Instrument reference by name.  A reference from a <a href="../Devices_Manual_guide/node02AB.html">SMUS</a> score to actual
instrument data is normally by name.  The score simply names the
instrument, for instance &#034;tubular bells&#034;.  It's up to the player program
to find suitable instrument data for its output devices.  (More on
locating instruments below.)

Instrument reference by MIDI channel and preset.  A <a href="../Devices_Manual_guide/node02AB.html">SMUS</a> score can also
ask for a specific MIDI channel number and preset number.  MIDI programs
may honor these specific requests.  But these channel allocations can
become obsolete or the score may be played without MIDI hardware.  In such
cases, the player program should fall back to instrument reference by name.

Instrument reference via instrument register.  Each reference from a <a href="../Devices_Manual_guide/node02AB.html">SMUS</a>
track to an instrument is via an &#034;instrument register&#034;.  Each track
selects an instrument register which in turn points to the specific
instrument data.

Each score has an array of <a href="../Devices_Manual_guide/node02B0.html">instrument registers</a>.  Each track has a
&#034;current instrument setting&#034;, which is simply an index number into this
array.  This is like setting a raster image's pixel to a specific color
number (a reference to a color value through a &#034;color register&#034;) or
setting a text character to a specific font number (a reference to a font
through a &#034;font register&#034;). This is diagramed below:

         +------------+--------+--------+------------+--------+-----------+
Track 1  | Set Inst 2 |  Note  |  Note  | Set Inst 1 |  Note  |  Note...  |
     .---+------------+--------+--------+------------+--------+-----------+
    /   ______________________________________/
   /   /
  /   /
  \   \       +------------------+       +--------------------------------+
   \   `-----&#062;| &#034;piano&#034;          |-----&#062; |   (internal piano data)        |
    \         +------------------+       +--------------------------------+
     `-------&#062;| &#034;guitar&#034;         |-----&#062; |   (internal guitar data)       |
Instrument    +------------------+       +--------------------------------+
 Registers    | &#034;Spanish guitar&#034; |-----&#062; | (internal Spanish guitar data) |
              +------------------+       +--------------------------------+
       .-----&#062;| &#034;bass drum&#034;      |-----&#062; |  (internal bass drum data)     |
      /       +------------------+       +--------------------------------+
     /
     \
      \
       `-+------------+--------+--------+--------+--------+-----------+
Track 2  | Set Inst 4 |  Note  |  Note  |  Note  |  Note  |  Note...  |
         +------------+--------+--------+--------+--------+-----------+


Locating instrument data by name.  &#034;INS1&#034; chunks in a <a href="../Devices_Manual_guide/node02AB.html">SMUS</a> score name the
instruments to use for that score.  The player program uses these names to
locate instrument data.

To locate instrument data, the player performs these steps:

For each instrument register, check for a suitable instrument with the
right name?

    {&#034;Suitable&#034; means usable with an available output device and driver.}
    {Use case independent name comparisons.}

  1.Initialize the instrument register to point to a built-in default
    instrument.

    {Every player program must have default instruments.  Simple programs
    stop here.  For fancier programs, the default instruments are a
    backstop in case the search fails.}

  2.Check any instrument <a href="../Devices_Manual_guide/node01C7.html#line51">FORM</a>s embedded in the FORM <a href="../Devices_Manual_guide/node02AB.html">SMUS</a>.  (This is an
    &#034;instrument cache&#034;.)

  3.Else check the default instruments.

  4.Else search the local &#034;instrument library&#034;.  (The library might simply
    be a disk directory.)

  5.If all else fails, display the desired instrument name and ask the
    user to pick an available one.


This algorithm can be implemented to varying degrees of fanciness.  It's
OK to stop searching after step 1, 2, 3, or 4.  If exact instrument name
matches fail, it's OK to try approximate matches.  E.g., search for any
kind of &#034;guitar&#034; if you can't find a &#034;Spanish guitar&#034;.  In any case, a
player only has to search for instruments while loading a score.

When the embedded instruments are suitable, they save the program from
asking the user to insert the &#034;right&#034; disk in a drive and searching that
disk for the &#034;right&#034; instrument.  But it's just a cache.  In practice, we
rarely move scores between environments so the cache often works.  When
the score is moved, embedded instruments must be discarded (a cache miss)
and other instrument data used.

Be careful to distinguish an instrument's name from its filename--the
contents name vs. container name.  A musical instrument <a href="../Devices_Manual_guide/node01C7.html#line51">FORM</a> should
contain a NAME chunk that says what instrument it really is.  Its
filename, on the other hand, is a handle used to locate the FORM.
Filenames are affected by external factors like drives, directories, and
filename character and length limits.  Instrument names are not.

Issue: Consider instrument naming conventions for consistency.  Consider a
naming convention that aids approximate matches.  E.g., we could accept
&#034;guitar, bass1&#034; if we didn't find &#034;guitar, bass&#034;.  Failing that, we could
accept &#034;guitar&#034; or any name starting with &#034;guitar&#034;.

Set instrument events.  If the player implements the set-instrument score
event, each track can change instrument numbers while playing.  That is,
it can switch between the loaded instruments.

Initial instrument settings.  Each time a score is played, every track's
running state information must be initialized.  Specifically, each track's
instrument number should be initialized to its track number.  Track 1 to
instrument 1, etc.  It's as if each track began with a set-instrument
event.

In this way, programs that don't implement the set-instrument event still
assign an instrument to each track.  The INS1 chunks imply these initial
instrument settings.
<!-- AG2HTML: BODY=END -->
</pre>

<!-- [amigadev.elowar.com] Automatically generated content... -->
<hr />
<pre>[Back to <a href="http://amigadev.elowar.com/">Amiga Developer Docs</a>]</pre>
<!-- [amigadev.elowar.com] End of automatically generated content. -->

</body>
</html>
