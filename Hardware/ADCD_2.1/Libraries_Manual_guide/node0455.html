<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<!-- AG2HTML: CONVERTER=AG2HTML/1.1 FORMAT=AMIGAGUIDE/34.11 FILE="Libraries/Lib_33" NODE="33-8-1-1" TITLE="33 / / Custom Stream Handlers / Installing a Custom Stream Handler" INDEX="Libraries/Lib_Index/MAIN" -->
<head>
<title>33 / / Custom Stream Handlers / Installing a Custom Stream Handler</title>
</head>
<body>
<img src="../images/toc_d.gif" alt="[Contents]">
<a href="../Libraries_Manual_guide/node002C.html"><img src="../images/index.gif" alt="[Index]" border=0></a>
<img src="../images/help_d.gif" alt="[Help]">
<img src="../images/retrace_d.gif" alt="[Retrace]">
<a href="../Libraries_Manual_guide/node0454.html"><img src="../images/prev.gif" alt="[Browse &#060;]" border=0></a>
<a href="../Libraries_Manual_guide/node0456.html"><img src="../images/next.gif" alt="[Browse &#062;]" border=0></a>
<hr>
<pre>
<!-- AG2HTML: BODY=START -->
To initialize your <a href="../Libraries_Manual_guide/node042C.html">IFFHandle</a> to point to your custom stream and stream
handler, you must open your stream and place a pointer to the stream in
your IFFHandle's <a href="../Libraries_Manual_guide/node042E.html">iff_Stream</a> field.  This pointer could be the return from
<a href="../Libraries_Manual_guide/node0430.html">fopen()</a>, or an Exec device I/O request, or any other type of pointer which
will provide your custom stream handler with a way to manage your stream.
For example:

    iff-&#062;iff_Stream = (ULONG) fopen(&#034;foo&#034;);

Next, you must install your custom handler for this stream, and also tell
IFFParse the seek capabilities of your stream.  To install your custom
stream handler, you must first set up a <a href="../Libraries_Manual_guide/node04A3.html">Hook</a> structure (&#060;utility/<a href="../Includes_and_Autodocs_2._guide/node012D.html#line22">hooks.h</a>&#062;)
to point to your stream handling function.  Then use <a href="../Libraries_Manual_guide/node042E.html#line29">InitIFF()</a> to install
your stream handler and also tell IFFParse the seek capabilities of your
stream.  There is &#034;some assembly required&#034;.

Release 2 hook function calling conventions specify a register interface.
For an IFFParse custom stream hook, at entry, A0 contains a pointer to the
hook, A2 is a pointer to your <a href="../Libraries_Manual_guide/node042C.html">IFFHandle</a>, and A1 is a pointer to a command
packet, which tells you what to do.  A6 contains a pointer to
IFFParseBase.  You may trash A0, A1, D0, and D1.  All other registers must
be preserved.  You return your error code in D0.  A return of 0 indicates
success.  A non-zero return indicates an error.

If your compiler supports registered function parameters, you may use a
registerized C function entry as the <a href="../Libraries_Manual_guide/node04A3.html#line14">h_Entry</a> hook entry point:


/* mystreamhandler - SAS C custom stream handler with */
/* registerized arguments                             */
static LONG __saveds __asm
mystreamhandler (
    register __a0 struct Hook               *hook,
    register __a2 struct IFFHandle          *iff,
    register __a1 struct IFFStreamCmd       *actionpkt
    )
{
/*
 * Code to handle the stream commands - see end this section
 * for a complete example custom stream handler function.
 *
 */
}

/* Initialization of Hook structure for registerized  */
/* handler function                                   */
struct Hook mystreamhook {
    { NULL },
    (ULONG (*)()) mystreamhandler,
                  /* h_Entry, registerized function entry */
    NULL,
    NULL };

/* Open custom stream and InitIFF to custom stream handler */
if ( iff-&#062;iff_Stream = (ULONG) myopen(&#034;foo&#034;) )
    {
    InitIFF (iff, IFFF_FSEEK | IFFF_RSEEK, &#038;mystreamhook);
    }


Alternately, you could initialize your <a href="../Libraries_Manual_guide/node04A3.html">Hook</a> structure's <a href="../Libraries_Manual_guide/node04A3.html#line14">h_Entry</a> to point
to a standard assembler stub which would push the register arguments on
the stack and then call a standard args C function.  In this case, you
must store the address of your C function in the <a href="../Libraries_Manual_guide/node04A3.html#line27">h_SubEntry</a> field of the
Hook structure so the assembler stub can find and call your C entry point.
A sample assembler hook entry stub follows.  This would be assembled as
<a name="line68">hookentry.o and linked with your C code.</a>


* HookEntry.asm for SAS C

        INCLUDE &#034;exec/types.i&#034;
        INCLUDE &#034;utility/hooks.i&#034;

        XDEF    _HookEntry

        section code

 _HookEntry:
        move.l  a6,-(sp)
        move.l  a1,-(sp)                ; push message packet pointer
        move.l  a2,-(sp)                ; push object pointer
        move.l  a0,-(sp)                ; push hook pointer
        move.l  h_SubEntry(a0),a0       ; fetch C entry point ...
        jsr     (a0)                    ; ... and call it
        lea     12(sp),sp               ; fix stack
        move.l  (sp)+,a6
        rts

        end


When using an assembler HookEntry stub, your C program's custom stream
handler interface would be initialized as follows:


extern LONG HookEntry();        /* The assembler entry */

/* mystreamhandler - a standard args C function custom stream handler*/
static LONG mystreamhandler ( struct Hook *hook,
                              struct IFFHandle *iff,
                              struct IFFStreamCmd *actionpkt )
{
/* Code to handle the stream commands - see end of this section
 * for a complete example custom stream handler function.
 */
}

/* Initialization of Hook for asm HookEntry and std args C function */
struct Hook mystreamhook {
    { NULL },
    (ULONG (*)()) HookEntry,        /* h_Entry, assembler stub entry */
    (ULONG (*)()) mystreamhandler,
                              /* h_SubEntry, std args function entry */
    NULL };

/* Open custom stream and InitIFF to custom stream handler */
if ( iff-&#062;iff_Stream = (ULONG) myopen(&#034;foo&#034;) )
        {
        InitIFF (iff, IFFF_FSEEK | IFFF_RSEEK, &#038;mystreamhook);
        }
<!-- AG2HTML: BODY=END -->
</pre>

<!-- [amigadev.elowar.com] Automatically generated content... -->
<hr />
<pre>[Back to <a href="http://amigadev.elowar.com/">Amiga Developer Docs</a>]</pre>
<!-- [amigadev.elowar.com] End of automatically generated content. -->

</body>
</html>
