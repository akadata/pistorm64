<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<!-- AG2HTML: CONVERTER=AG2HTML/1.1 FORMAT=AMIGAGUIDE/34.11 FILE="Libraries/Lib_17" NODE="17-5-2" TITLE="17 / Libraries and Devices / Calling a Library Function" INDEX="Libraries/Lib_Index/MAIN" -->
<head>
<title>17 / Libraries and Devices / Calling a Library Function</title>
</head>
<body>
<img src="../images/toc_d.gif" alt="[Contents]">
<a href="../Libraries_Manual_guide/node002C.html"><img src="../images/index.gif" alt="[Index]" border=0></a>
<img src="../images/help_d.gif" alt="[Help]">
<img src="../images/retrace_d.gif" alt="[Retrace]">
<a href="../Libraries_Manual_guide/node028F.html"><img src="../images/prev.gif" alt="[Browse &#060;]" border=0></a>
<a href="../Libraries_Manual_guide/node0291.html"><img src="../images/next.gif" alt="[Browse &#062;]" border=0></a>
<hr>
<pre>
<!-- AG2HTML: BODY=START -->
To call a function in an Amiga system library, an assembler application
must put the library's base address in register A6 and JSR to the
function's <a href="../Libraries_Manual_guide/node028F.html">LVO</a> relative to A6.  For example to call the Intuition function
<a href="../Libraries_Manual_guide/node00FC.html">DisplayBeep()</a>:


;***********************************************************************
        xref    _LVODisplayBeep
;...
        move.l  A6, -(sp)               ;save the current contents of A6
;---- intuition.library must already be opened
;---- and IntuitionBase must contain its base address
        move.l  IntuitionBase, A6       ;put intuition base pointer in A6
        jsr     _LVODisplayBeep(A6)     ;call DisplayBeep()
        move.l  (SP)+, A6               ;restore A6 to its original value


<a href="../Includes_and_Autodocs_2._guide/node00DC.html#line59">IntuitionBase</a> contains a pointer to the Intuition library's library base
and _LVODisplayBeep is the <a href="../Libraries_Manual_guide/node028F.html">LVO</a> for the <a href="../Libraries_Manual_guide/node00FC.html">DisplayBeep()</a> function.  The
external reference (xref) to _LVODisplayBeep is resolved from the linker
library, amiga.lib.  This linker library contains the LVO's for all of the
standard Amiga libraries.  Each LVO label starts with &#034;_LVO&#034; followed by
the name of the library function.

    System Functions Do Not Preserve D0, D1, A0 and A1.
    ---------------------------------------------------
    If you need to preserve D0, D1, A0, or A1 between calls to system
    functions, you will have to save and restore these values yourself.
    Amiga system functions use these registers as scratch registers and
    may write over the values your program left in these registers.  The
    system functions preserve the values of all other registers.  The
    result of a system function, if any, is returned in D0.


      Some Task             LVO Table                  LibFuncY()
      ---------         __________________             ----------
                       |                  |
                       |        &#183;         |
      main()           |        &#183;         |
         &#183;             | JMP to LibFuncZ  |       {
         &#183;             |- - - - - - - - - |         blah = openblah();
         x=       ____\| JMP to LibFuncY  |____\    dosomething();
      LibFuncY()      /|- - - - - - - - - |    /    closeblah(blah);
         &#183;             | JMP to LibFuncX  |       }
         &#183;             |        &#183;         |
                       |        &#183;         |
                       |__________________|
                       |                  |
                       |   Library Base   |
                       |__________________|

   A task calls a        which calls the          which JMP's to the
  library function...  functions JMP vector...  actual library function.


                 Figure 17-2: Calling a Library Function
<a name="line58"></a>

The example above is the actual assembly code generated by the macro named
LINKLIB, which is defined in &#060;exec/<a href="../Includes_and_Autodocs_2._guide/node009F.html#line117">libraries.i</a>&#062;.  The following fragment
performs the same function as the fragment above:

<a name="line64">    LINKLIB _LVODisplayBeep, IntuitionBase</a>

The amiga.lib linker library also contains small functions called stubs
for each function in the Amiga OS.  These stubs are normally for use with
C code.

Function parameters in C are normally pushed on the stack when a program
calls a function.  This presents a bit of a problem for the C programmer
when calling Amiga OS functions because the Amiga OS functions expect
their parameters to be in specific CPU registers. Stubs solve this problem
by copying the parameters from the stack to the appropriate register.

For example, the Autodoc for the Intuition library function <a href="../Libraries_Manual_guide/node0129.html">MoveWindow()</a>
shows which registers MoveWindow() expects its parameters to be:

    MoveWindow(window, deltaX, deltaY);
                 A0      D0      D1

The stub for <a href="../Libraries_Manual_guide/node0129.html">MoveWindow()</a> in amiga.lib has to copy window to register A0,
deltaX to register D0, and deltaY to register D1.

The stub also copies Intuition library base into A6 and does an
address-relative JSR to <a href="../Libraries_Manual_guide/node0129.html">MoveWindow()</a>'s <a href="../Libraries_Manual_guide/node028F.html">LVO</a> (relative to A6).  The stub
gets the library base from a global variable in your code called
<a href="../Includes_and_Autodocs_2._guide/node00DC.html#line59">IntuitionBase</a>.  If you are using the stubs in amiga.lib to call Intuition
library functions, you must declare a global variable called
IntuitionBase.  It must be called IntuitionBase because amiga.lib is
<a name="line91">specifically looking for the label IntuitionBase.</a>

    /* This global declaration is here so amiga.lib can find
       the intuition.library base pointer.
    */
    struct Library *IntuitionBase;
            ...

    void main(void)
    {
            ...

            /* initialize IntuitionBase */
            if (IntuitionBase = OpenLibrary(&#034;intuition.library&#034;, 33L))
            {
                    ...

                    /* When this code gets linked with amiga.lib, the
                       linker extracts the DisplayBeep() stub routine from
                       from amiga.lib and copies it into the executable.
                       The stub copies whatever is in the variable
                       IntuitionBase into A6, and JSRs to
                       _LVODisplayBeep(A6).
                    */
                    DisplayBeep();
                    ...

                    CloseLibrary(IntuitionBase);
            }
            ...
    }

There is a specific label in amiga.lib for the library base of every
library in the Amiga operating system.  The chart below lists the names of
the library base pointer amiga.lib associates with each Amiga OS library.
The labels for library bases are also in the &#034;<a href="../Includes_and_Autodocs_2._guide/node0551.html">Function Offsets Reference</a>&#034;
list in the Amiga ROM Kernel Reference Manual: Includes and Autodocs.
<a name="line128"></a>

                Table 17-1: Amiga.lib Library Base Labels
       _________________________________________________________
      |                                                         |
      |   Library Name                Library Base Pointer Name |
      |---------------------------------------------------------|
      |   <a href="../Includes_and_Autodocs_2._guide/node017B.html">asl</a>.library                 AslBase                   |
      |   <a href="../Includes_and_Autodocs_2._guide/node019C.html">commodities</a>.library         CxBase                    |
      |   <a href="../Includes_and_Autodocs_2._guide/node01F2.html">diskfont</a>.library            DiskfontBase              |
      | * <a href="../Includes_and_Autodocs_2._guide/node0279.html">dos</a>.library                 DOSBase                   |
      | * <a href="../Includes_and_Autodocs_2._guide/node0322.html">exec</a>.library                SysBase                   |
      |   <a href="../Includes_and_Autodocs_2._guide/node03AD.html">expansion</a>.library           ExpansionBase             |
      |   <a href="../Includes_and_Autodocs_2._guide/node03E6.html">gadtools</a>.library            GadToolsBase              |
      |   <a href="../Includes_and_Autodocs_2._guide/node040D.html">graphics</a>.library            GfxBase                   |
      |   <a href="../Includes_and_Autodocs_2._guide/node0182.html">icon</a>.library                IconBase                  |
      |   <a href="../Includes_and_Autodocs_2._guide/node01B6.html">iffparse</a>.library            IFFParseBase              |
      |   <a href="../Includes_and_Autodocs_2._guide/node01F8.html">intuition</a>.library           IntuitionBase             |
      |   <a href="../Includes_and_Autodocs_2._guide/node0312.html">keymap</a>.library              KeyMapBase                |
      |   <a href="../Includes_and_Autodocs_2._guide/node038D.html">layers</a>.library              LayersBase                |
      |   <a href="../Includes_and_Autodocs_2._guide/node03C0.html">mathffp</a>.library             MathBase                  |
      |   <a href="../Includes_and_Autodocs_2._guide/node03F9.html">mathieeedoubbas</a>.library     MathIeeeDoubBasBase       |
      |   <a href="../Includes_and_Autodocs_2._guide/node0492.html">mathieeedoubtrans</a>.library   MathIeeeDoubTransBase     |
      |   <a href="../Includes_and_Autodocs_2._guide/node018F.html">mathieeesingbas</a>.library     MathIeeeSingBasBase       |
      |   <a href="../Includes_and_Autodocs_2._guide/node01E0.html">mathieeesingtrans</a>.library   MathIeeeSingTransBase     |
      |   <a href="../Includes_and_Autodocs_2._guide/node0267.html">mathtrans</a>.library           MathTransBase             |
      |   <a href="../Includes_and_Autodocs_2._guide/node0317.html">rexxsys</a>.library             RexxSysBase               |
      |   <a href="../Includes_and_Autodocs_2._guide/node0317.html">rexxsupport</a>.library         RexxSupBase               |
      |   <a href="../Includes_and_Autodocs_2._guide/node03AB.html">translator</a>.library          TranslatorBase            |
      |   <a href="../Includes_and_Autodocs_2._guide/node03CD.html">utility</a>.library             UtilityBase               |
      |   version .library             (system private)          |
      |   <a href="../Includes_and_Autodocs_2._guide/node0406.html">workbench</a>.library           WorkbenchBase             |
      |   Library Name                Library Base Pointer Name |
      |---------------------------------------------------------|
      | * Automatically opened by the standard C startup module |
      |_________________________________________________________|


The chart mentions that SysBase and DOSBase are already set up by the
standard C startup module.  For more information on the startup module,

    You May Not Need amiga.lib.
    ---------------------------
    Many C compilers provide ways of using pragmas or registerized
    parameters, so that a C program does not have to link with an
    amiga.lib stub to access a library function.  See your compiler
    documentation for more details.
<!-- AG2HTML: BODY=END -->
</pre>

<!-- [amigadev.elowar.com] Automatically generated content... -->
<hr />
<pre>[Back to <a href="http://amigadev.elowar.com/">Amiga Developer Docs</a>]</pre>
<!-- [amigadev.elowar.com] End of automatically generated content. -->

</body>
</html>
