# PiStorm Kernel Driver - Upstream Preparation

This directory contains the PiStorm kernel driver prepared for upstream submission to the Linux kernel.

## Overview

The PiStorm is a hardware bridge that connects an Amiga computer to a Raspberry Pi, allowing the Pi to act as a co-processor for the Amiga. This kernel driver provides the interface between userspace applications and the PiStorm hardware.

## Changes Made for Upstream Submission

### 1. Device Tree Integration
- Created proper DT binding YAML file (`Documentation/devicetree/bindings/misc/akadata,pistorm.yaml`)
- Replaced "compat scanning" with proper platform device binding
- Added proper resource management via device tree

### 2. GPIO Descriptor (gpiod) Integration
- Replaced legacy `gpio_request()` calls with modern `devm_gpiod_get()` and `devm_gpiod_get_array()` APIs
- Proper GPIO resource management using device-managed functions

### 3. Platform Driver Conversion
- Converted from global initialization to proper `platform_driver` with probe/remove functions
- Used `devm_*` allocation and registration functions
- Proper per-device struct management

### 4. UAPI Versioning and Header Split
- Updated UAPI header to use proper kernel conventions (`#ifndef _UAPI_LINUX_PISTORM_H`)
- Removed `__attribute__((packed))` from UAPI structs for better portability
- Added capability defines (`PISTORM_CAP_BUSOP`, `PISTORM_CAP_BATCH`, etc.) instead of magic numbers
- Created kernel-internal header (`include/linux/pistorm.h`) to wrap UAPI header
- Added `PISTORM_IOC_QUERY` ioctl for version/capability queries
- Maintained backward compatibility with existing ioctls

### 5. Clock Framework Integration
- Added support for Common Clock Framework (CCF) where available
- Used `devm_clk_get_optional()` and `clk_prepare_enable()` APIs
- Removed hardcoded CPRMAN register programming

### 6. Pinctrl Integration
- Added proper pinctrl state management for bus direction switching
- Defined pinctrl states for "default", "bus-out", and "bus-in" modes
- Requires pinctrl states to be present for proper operation
- Allows proper pinmuxing on different SoCs (BCM283x, BCM2711, RP1)

### 7. Module Parameter Replacement
- Replaced module parameters with Device Tree properties
- Added `txn-timeout-ms` and `reset-pulse-ms` properties

### 8. File Operations Fixes
- Fixed miscdevice open/ioctl wiring to properly set file->private_data in ps_open()
- Used gpiod_set_value_cansleep() and gpiod_get_value_cansleep() for GPIO operations to comply with sleep rules
- Removed unused gpio_base and direct-MMIO helpers

### 9. Kconfig and Build Integration
- Added proper Kconfig entry in `drivers/misc/Kconfig`
- Updated Makefile in `drivers/misc/Makefile`
- Created MAINTAINERS file entry

### 10. Device Tree Binding Fixes
- Fixed YAML schema and indentation to pass dt_binding_check
- Made pinctrl states mandatory for proper operation
- Removed reg/reg-names as MMIO is optional in this driver
- Simplified examples to use generic GPIO controller references
- Added proper maintainers section

## Files Added

- `drivers/misc/pistorm/` - New driver directory
- `drivers/misc/pistorm/pistorm-platform.c` - Main driver implementation with platform driver, gpiod, clk, and pinctrl
- `drivers/misc/pistorm/pistorm-main.c` - Alternative driver implementation with platform driver, gpiod, clk, and pinctrl
- `drivers/misc/pistorm/Kconfig` - Kconfig entry
- `drivers/misc/pistorm/Makefile` - Makefile for the driver
- `Documentation/devicetree/bindings/misc/akadata,pistorm.yaml` - DT binding documentation
- `Documentation/ABI/testing/dev-pistorm` - ABI documentation
- `include/uapi/linux/pistorm.h` - Updated UAPI header with proper kernel conventions and versioning
- `include/linux/pistorm.h` - Kernel-internal header wrapper
- `MAINTAINERS` - Maintainers file entry
- `pistorm-rp1-overlay.dts` - Sample device tree overlay for Pi 5 (RP1)
- `pistorm-bcm-overlay.dts` - Sample device tree overlay for Pi 3/4 (BCM283x/BCM2711)

## Pi Compatibility

The driver supports:
- Raspberry Pi 2 (BCM2836)
- Raspberry Pi 3 (BCM2837)
- Raspberry Pi 4 (BCM2711)
- Raspberry Pi 5 (RP1) - with proper device tree configuration

The key improvement for Pi 5 compatibility is the removal of hardcoded register addresses and the use of proper kernel frameworks (gpiod, clk, pinctrl) that abstract away SoC differences.

## Testing

To test the driver:
1. Compile with `CONFIG_PISTORM=m` or `CONFIG_PISTORM=y`
2. Load the driver: `sudo modprobe pistorm`
3. Access the device: `/dev/pistorm`

## Device Tree Configuration

The driver requires proper device tree configuration. See the provided overlay examples for guidance:
- `pistorm-bcm-overlay.dts` for Pi 3/4
- `pistorm-rp1-overlay.dts` for Pi 5

## Maintainer

- Andrew Smalley <andrew@akadata.ltd>