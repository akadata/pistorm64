From a2d0c695ecc1d930cd368f4dc547d65ea24b375e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Niklas=20Ekstr=C3=B6m?= <mail@niklasekstrom.nu>
Date: Mon, 18 Jan 2021 22:33:27 +0100
Subject: [PATCH 5/6] Add FLIP_DONE event


diff --git a/Software/aws/aws.c b/Software/aws/aws.c
index c315421..72f65ac 100644
--- a/Software/aws/aws.c
+++ b/Software/aws/aws.c
@@ -26,13 +26,14 @@
 #include "../a314device/proto_a314.h"
 
 #define AWS_REQ_OPEN_WINDOW 1
-#define AWS_REQ_CLOSE_WINDOW 2
-#define AWS_REQ_FLIP_BUFFER 3
-#define AWS_RES_OPEN_WINDOW_FAIL 4
-#define AWS_RES_OPEN_WINDOW_SUCCESS 5
-#define AWS_EVENT_CLOSE_WINDOW 6
-#define AWS_REQ_WB_SCREEN_INFO 7
-#define AWS_RES_WB_SCREEN_INFO 8
+#define AWS_RES_OPEN_WINDOW_FAIL 2
+#define AWS_RES_OPEN_WINDOW_SUCCESS 3
+#define AWS_REQ_CLOSE_WINDOW 4
+#define AWS_REQ_FLIP_BUFFER 5
+#define AWS_REQ_WB_SCREEN_INFO 6
+#define AWS_RES_WB_SCREEN_INFO 7
+#define AWS_EVENT_CLOSE_WINDOW 8
+#define AWS_EVENT_FLIP_DONE 9
 
 struct WindowInfo
 {
@@ -287,7 +288,14 @@ static void handle_req_flip_buffer()
 	UBYTE wid = arbuf[1];
 	struct WindowInfo *wi = find_window_by_id(wid);
 	if (wi)
+	{
 		redraw_window(wi);
+
+		wait_a314_write_complete();
+		awbuf[0] = AWS_EVENT_FLIP_DONE;
+		awbuf[1] = wi->wid;
+		start_a314_write(2);
+	}
 }
 
 static struct Screen *find_wb_screen()
diff --git a/Software/aws/awslib.py b/Software/aws/awslib.py
index 598b75b..89f4d55 100644
--- a/Software/aws/awslib.py
+++ b/Software/aws/awslib.py
@@ -20,13 +20,14 @@ logger = logging.getLogger(__name__)
 logger.setLevel(logging.INFO)
 
 AWS_CLIENT_REQ_OPEN_WINDOW = 1
-AWS_CLIENT_REQ_CLOSE_WINDOW = 2
-AWS_CLIENT_REQ_COPY_FLIP_BUFFER = 3
-AWS_CLIENT_RES_OPEN_WINDOW_FAIL = 4
-AWS_CLIENT_RES_OPEN_WINDOW_SUCCESS = 5
-AWS_CLIENT_EVENT_CLOSE_WINDOW = 6
-AWS_CLIENT_REQ_WB_SCREEN_INFO = 7
-AWS_CLIENT_RES_WB_SCREEN_INFO = 8
+AWS_CLIENT_RES_OPEN_WINDOW_FAIL = 2
+AWS_CLIENT_RES_OPEN_WINDOW_SUCCESS = 3
+AWS_CLIENT_REQ_CLOSE_WINDOW = 4
+AWS_CLIENT_REQ_COPY_FLIP_BUFFER = 5
+AWS_CLIENT_REQ_WB_SCREEN_INFO = 6
+AWS_CLIENT_RES_WB_SCREEN_INFO = 7
+AWS_CLIENT_EVENT_CLOSE_WINDOW = 8
+AWS_CLIENT_EVENT_FLIP_DONE = 9
 
 class Window(object):
     def __init__(self, wid):
@@ -73,6 +74,12 @@ class Connection(threading.Thread):
         elif cmd == AWS_CLIENT_EVENT_CLOSE_WINDOW:
             wid = struct.unpack('=H', msg[1:3])[0]
             self.callbacks.event_close_window(self, wid)
+        elif cmd == AWS_CLIENT_EVENT_FLIP_DONE:
+            wid = struct.unpack('=H', msg[1:3])[0]
+            self.callbacks.event_flip_done(self, wid)
+        else:
+            logger.error('Received unknown command %d, shutting down', cmd)
+            exit(-1)
 
     def handle_readable(self):
         buf = self.sock.recv(128)
diff --git a/Software/aws/awsproxy.py b/Software/aws/awsproxy.py
index ef29809..4b73608 100644
--- a/Software/aws/awsproxy.py
+++ b/Software/aws/awsproxy.py
@@ -137,25 +137,24 @@ write_mem_reqs = []
 SERVICE_NAME = b'awsproxy'
 
 AWS_REQ_OPEN_WINDOW = 1
-AWS_REQ_CLOSE_WINDOW = 2
-AWS_REQ_FLIP_BUFFER = 3
-AWS_RES_OPEN_WINDOW_FAIL = 4
-AWS_RES_OPEN_WINDOW_SUCCESS = 5
-AWS_EVENT_CLOSE_WINDOW = 6
-AWS_REQ_WB_SCREEN_INFO = 7
-AWS_RES_WB_SCREEN_INFO = 8
-
-# Definiera de olika meddelandena som går mellan klient och awsproxy.
-AWS_CLIENT_REQ_OPEN_WINDOW = 1
-AWS_CLIENT_REQ_CLOSE_WINDOW = 2
-AWS_CLIENT_REQ_COPY_FLIP_BUFFER = 3
-AWS_CLIENT_RES_OPEN_WINDOW_FAIL = 4
-AWS_CLIENT_RES_OPEN_WINDOW_SUCCESS = 5
-AWS_CLIENT_EVENT_CLOSE_WINDOW = 6
-AWS_CLIENT_REQ_WB_SCREEN_INFO = 7
-AWS_CLIENT_RES_WB_SCREEN_INFO = 8
+AWS_RES_OPEN_WINDOW_FAIL = 2
+AWS_RES_OPEN_WINDOW_SUCCESS = 3
+AWS_REQ_CLOSE_WINDOW = 4
+AWS_REQ_FLIP_BUFFER = 5
+AWS_REQ_WB_SCREEN_INFO = 6
+AWS_RES_WB_SCREEN_INFO = 7
+AWS_EVENT_CLOSE_WINDOW = 8
+AWS_EVENT_FLIP_DONE = 9
 
-# Kan stänga klientanslutningen när som helst, vilket resettar allt state.
+AWS_CLIENT_REQ_OPEN_WINDOW = 1
+AWS_CLIENT_RES_OPEN_WINDOW_FAIL = 2
+AWS_CLIENT_RES_OPEN_WINDOW_SUCCESS = 3
+AWS_CLIENT_REQ_CLOSE_WINDOW = 4
+AWS_CLIENT_REQ_COPY_FLIP_BUFFER = 5
+AWS_CLIENT_REQ_WB_SCREEN_INFO = 6
+AWS_CLIENT_RES_WB_SCREEN_INFO = 7
+AWS_CLIENT_EVENT_CLOSE_WINDOW = 8
+AWS_CLIENT_EVENT_FLIP_DONE = 9
 
 def process_drv_data(msg):
     cmd = msg[0]
@@ -181,6 +180,12 @@ def process_drv_data(msg):
             w = windows[wid]
             c = w.client
             c.send(struct.pack('=BH', AWS_CLIENT_EVENT_CLOSE_WINDOW, w.cwid))
+    elif cmd == AWS_EVENT_FLIP_DONE:
+        wid = msg[1]
+        if wid in windows:
+            w = windows[wid]
+            c = w.client
+            c.send(struct.pack('=BH', AWS_CLIENT_EVENT_FLIP_DONE, w.cwid))
     elif cmd == AWS_RES_WB_SCREEN_INFO:
         width, height, depth = struct.unpack('>HHH', msg[2:8])
         pal = list(msg[8:])
-- 
2.47.3

