#!/usr/sbin/nft -f

flush ruleset

############################
# FILTER (inet)
############################
table inet filter {

  chain input {
    type filter hook input priority 0;
    policy accept;

    # keep localhost sane
    iif "lo" accept
  }

  chain forward {
    type filter hook forward priority 0;
    policy drop;

    # Allow return traffic back through the NAT
    ct state established,related accept

    # Allow Amiga/tap0 -> wlan0 (out to the world)
    iifname "tap0" oifname "wlan0" accept

    # Allow wlan0 -> tap0 only when it is return traffic
    # (covered by ct state rule above)
  }

  chain output {
    type filter hook output priority 0;
    policy accept;
  }
}

############################
# NAT (ip)
############################
table ip nat {

  chain postrouting {
    type nat hook postrouting priority 100;
    policy accept;

    # Masquerade anything leaving via wlan0
    oifname "wlan0" masquerade
  }
}

